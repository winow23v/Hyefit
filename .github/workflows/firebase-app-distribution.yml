name: Firebase App Distribution

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      release_notes:
        description: "릴리즈 노트(선택)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: firebase-app-distribution-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android:
    runs-on: ubuntu-latest
    env:
      FIREBASE_ANDROID_APP_ID: ${{ secrets['FIREBASE_ANDROID_APP_ID'] }}
      FIREBASE_TESTERS: ${{ secrets['FIREBASE_TESTERS'] }}
      FIREBASE_TESTER_GROUPS: ${{ secrets['FIREBASE_TESTER_GROUPS'] }}
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets['FIREBASE_SERVICE_ACCOUNT_JSON'] }}
      ANDROID_GOOGLE_SERVICES_JSON_BASE64: ${{ secrets['ANDROID_GOOGLE_SERVICES_JSON_BASE64'] }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets['ANDROID_KEYSTORE_BASE64'] }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets['ANDROID_KEYSTORE_PASSWORD'] }}
      ANDROID_KEY_ALIAS: ${{ secrets['ANDROID_KEY_ALIAS'] }}
      ANDROID_KEY_PASSWORD: ${{ secrets['ANDROID_KEY_PASSWORD'] }}
      SUPABASE_URL: ${{ secrets['SUPABASE_URL'] }}
      SUPABASE_ANON_KEY: ${{ secrets['SUPABASE_ANON_KEY'] }}
      SUPABASE_EMAIL_REDIRECT_URL: ${{ secrets['SUPABASE_EMAIL_REDIRECT_URL'] }}
      FIREBASE_TESTERS_CLEAN: ""
      FIREBASE_TESTER_GROUPS_CLEAN: ""
      HAS_FIREBASE_TESTERS: "false"
      HAS_FIREBASE_GROUPS: "false"
      HAS_ANDROID_RELEASE_SIGNING: "false"
      ANDROID_APK_PATH: ""
      RELEASE_NOTES: ""
      INPUT_RELEASE_NOTES: ${{ github.event.inputs.release_notes }}
      PUSH_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Normalize Firebase distribution targets
        shell: bash
        run: |
          testers="$(printf '%s' "${FIREBASE_TESTERS:-}" | tr -d '\r' | xargs)"
          groups="$(printf '%s' "${FIREBASE_TESTER_GROUPS:-}" | tr -d '\r' | xargs)"
          testers="$(printf '%s' "$testers" | sed 's/[[:space:]]*,[[:space:]]*/,/g')"
          groups="$(printf '%s' "$groups" | sed 's/[[:space:]]*,[[:space:]]*/,/g')"

          echo "FIREBASE_TESTERS_CLEAN=$testers" >> "$GITHUB_ENV"
          echo "FIREBASE_TESTER_GROUPS_CLEAN=$groups" >> "$GITHUB_ENV"

          if [[ -n "$testers" ]]; then
            echo "HAS_FIREBASE_TESTERS=true" >> "$GITHUB_ENV"
          else
            echo "HAS_FIREBASE_TESTERS=false" >> "$GITHUB_ENV"
          fi

          if [[ -n "$groups" ]]; then
            echo "HAS_FIREBASE_GROUPS=true" >> "$GITHUB_ENV"
          else
            echo "HAS_FIREBASE_GROUPS=false" >> "$GITHUB_ENV"
          fi

      - name: Validate required secrets
        shell: bash
        run: |
          required=(
            FIREBASE_ANDROID_APP_ID
            FIREBASE_SERVICE_ACCOUNT_JSON
            ANDROID_GOOGLE_SERVICES_JSON_BASE64
          )
          missing=()
          for var in "${required[@]}"; do
            if [[ -z "${!var}" ]]; then
              missing+=("$var")
            fi
          done
          if [[ ${#missing[@]} -gt 0 ]]; then
            echo "::error::Missing required secrets: ${missing[*]}"
            exit 1
          fi
          if [[ "$HAS_FIREBASE_TESTERS" != "true" && "$HAS_FIREBASE_GROUPS" != "true" ]]; then
            echo "::error::Set at least one of FIREBASE_TESTERS or FIREBASE_TESTER_GROUPS."
            exit 1
          fi

          signing_required=(
            ANDROID_KEYSTORE_BASE64
            ANDROID_KEYSTORE_PASSWORD
            ANDROID_KEY_ALIAS
            ANDROID_KEY_PASSWORD
          )
          missing_signing=()
          for var in "${signing_required[@]}"; do
            if [[ -z "${!var}" ]]; then
              missing_signing+=("$var")
            fi
          done
          if [[ ${#missing_signing[@]} -eq 0 ]]; then
            echo "HAS_ANDROID_RELEASE_SIGNING=true" >> "$GITHUB_ENV"
          else
            echo "::warning::Missing Android release signing secrets: ${missing_signing[*]}. Falling back to debug APK."
            echo "HAS_ANDROID_RELEASE_SIGNING=false" >> "$GITHUB_ENV"
          fi

      - name: Resolve release notes
        shell: bash
        run: |
          notes="$INPUT_RELEASE_NOTES"
          if [[ -z "$notes" ]]; then
            notes="$PUSH_COMMIT_MESSAGE"
          fi
          if [[ -z "$notes" ]]; then
            notes="Android CI build #${GITHUB_RUN_NUMBER}"
          fi
          notes="${notes//$'\n'/ }"
          echo "RELEASE_NOTES=$notes" >> "$GITHUB_ENV"

      - name: Prepare Android signing and Firebase config files
        shell: bash
        run: |
          mkdir -p android/app
          printf '%s' "$ANDROID_GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > android/app/google-services.json
          if [[ "$HAS_ANDROID_RELEASE_SIGNING" == "true" ]]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
            {
              echo "storePassword=$ANDROID_KEYSTORE_PASSWORD"
              echo "keyPassword=$ANDROID_KEY_PASSWORD"
              echo "keyAlias=$ANDROID_KEY_ALIAS"
              echo "storeFile=app/upload-keystore.jks"
            } > android/key.properties
          fi

      - name: Create .env file
        shell: bash
        run: |
          {
            echo "SUPABASE_URL=$SUPABASE_URL"
            echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY"
            echo "SUPABASE_EMAIL_REDIRECT_URL=$SUPABASE_EMAIL_REDIRECT_URL"
          } > .env

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        shell: bash
        run: |
          if [[ "$HAS_ANDROID_RELEASE_SIGNING" == "true" ]]; then
            flutter build apk --release
            echo "ANDROID_APK_PATH=build/app/outputs/flutter-apk/app-release.apk" >> "$GITHUB_ENV"
          else
            flutter build apk --debug
            echo "ANDROID_APK_PATH=build/app/outputs/flutter-apk/app-debug.apk" >> "$GITHUB_ENV"
          fi

      - name: Upload Android build to Firebase (groups + testers)
        if: ${{ env.HAS_FIREBASE_GROUPS == 'true' && env.HAS_FIREBASE_TESTERS == 'true' }}
        uses: wzieba/Firebase-Distribution-Github-Action@v1.7.1
        with:
          appId: ${{ env.FIREBASE_ANDROID_APP_ID }}
          serviceCredentialsFileContent: ${{ env.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: ${{ env.FIREBASE_TESTER_GROUPS_CLEAN }}
          testers: ${{ env.FIREBASE_TESTERS_CLEAN }}
          file: ${{ env.ANDROID_APK_PATH }}
          releaseNotes: ${{ env.RELEASE_NOTES }}

      - name: Upload Android build to Firebase (groups only)
        if: ${{ env.HAS_FIREBASE_GROUPS == 'true' && env.HAS_FIREBASE_TESTERS != 'true' }}
        uses: wzieba/Firebase-Distribution-Github-Action@v1.7.1
        with:
          appId: ${{ env.FIREBASE_ANDROID_APP_ID }}
          serviceCredentialsFileContent: ${{ env.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: ${{ env.FIREBASE_TESTER_GROUPS_CLEAN }}
          file: ${{ env.ANDROID_APK_PATH }}
          releaseNotes: ${{ env.RELEASE_NOTES }}

      - name: Upload Android build to Firebase (testers only)
        if: ${{ env.HAS_FIREBASE_GROUPS != 'true' && env.HAS_FIREBASE_TESTERS == 'true' }}
        uses: wzieba/Firebase-Distribution-Github-Action@v1.7.1
        with:
          appId: ${{ env.FIREBASE_ANDROID_APP_ID }}
          serviceCredentialsFileContent: ${{ env.FIREBASE_SERVICE_ACCOUNT_JSON }}
          testers: ${{ env.FIREBASE_TESTERS_CLEAN }}
          file: ${{ env.ANDROID_APK_PATH }}
          releaseNotes: ${{ env.RELEASE_NOTES }}

      - name: Send Slack notification (Success)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "✅ Firebase 배포 성공",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "✅ Android 배포 성공",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*브랜치:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*커밋:*\n<${{ github.event.head_commit.url }}|${GITHUB_SHA:0:7}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*작성자:*\n${{ github.event.head_commit.author.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*빌드 타입:*\n${{ env.HAS_ANDROID_RELEASE_SIGNING == 'true' && 'Release' || 'Debug' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*릴리즈 노트:*\n${{ env.RELEASE_NOTES }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack notification (Failure)
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "❌ Firebase 배포 실패",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ Android 배포 실패",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*브랜치:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*커밋:*\n<${{ github.event.head_commit.url }}|${GITHUB_SHA:0:7}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*작성자:*\n${{ github.event.head_commit.author.name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "빌드 또는 배포 중 오류가 발생했습니다."
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK