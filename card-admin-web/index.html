<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>í˜œí• ì¹´ë“œ ë§ˆìŠ¤í„° ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0A0E1A;
            color: #E5E7EB;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #60A5FA;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #9CA3AF;
            font-size: 14px;
        }

        .config-section {
            background: #1A1F2E;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #60A5FA;
        }

        input[type="text"], input[type="password"], input[type="email"] {
            width: 100%;
            padding: 10px 12px;
            background: #0A0E1A;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #E5E7EB;
            font-size: 14px;
        }

        input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: #60A5FA;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3B82F6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563EB;
        }

        .btn-secondary {
            background: #374151;
            color: #E5E7EB;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4B5563;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .status.info {
            background: rgba(96, 165, 250, 0.15);
            color: #60A5FA;
        }

        textarea {
            width: 100%;
            height: 500px;
            padding: 12px;
            background: #0A0E1A;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #E5E7EB;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #60A5FA;
        }

        .card-list {
            background: #1A1F2E;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .card-item {
            background: #0A0E1A;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-info h3 {
            font-size: 16px;
            color: #E5E7EB;
            margin-bottom: 4px;
        }

        .card-info p {
            font-size: 13px;
            color: #9CA3AF;
        }

        .btn-delete {
            background: #EF4444;
            color: white;
            padding: 8px 12px;
            font-size: 13px;
        }

        .btn-delete:hover {
            background: #DC2626;
        }

        .login-section {
            max-width: 500px;
            margin: 100px auto;
        }

        .hint {
            font-size: 12px;
            color: #6B7280;
            margin-top: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #9CA3AF;
        }

        .card-list-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .card-search {
            flex: 1 1 320px;
        }

        .card-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            color: #9CA3AF;
            font-size: 13px;
        }

        .page-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .page-btn {
            padding: 6px 10px;
            font-size: 12px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ ì „ -->
    <div id="loginSection" class="login-section">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1>í˜œí• ì¹´ë“œ ë§ˆìŠ¤í„° ê´€ë¦¬</h1>
            <p class="subtitle">PCì—ì„œ ì¹´ë“œ ë°ì´í„°ë¥¼ í¸ë¦¬í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <div class="config-section">
            <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input
                        type="email"
                        id="email"
                        placeholder="your-email@example.com"
                        required
                        autocomplete="email"
                    >
                </div>

                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input
                        type="password"
                        id="password"
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
                        required
                        autocomplete="current-password"
                    >
                </div>

                <button
                    type="submit"
                    class="btn-primary"
                    id="loginBtn"
                    style="width: 100%;"
                >
                    <span id="loginBtnText">ë¡œê·¸ì¸</span>
                </button>
            </form>

            <div id="loginStatus"></div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í›„ -->
    <div id="mainSection" style="display: none;">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>í˜œí• ì¹´ë“œ ë§ˆìŠ¤í„° ê´€ë¦¬</h1>
                        <p class="subtitle">ì¹´ë“œ ë°ì´í„° ëŒ€ëŸ‰ ë“±ë¡ ë° ê´€ë¦¬</p>
                    </div>
                    <button class="btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ (ê¶Œì¥) -->
            <div class="config-section">
                <h2>ğŸ“Š ì—‘ì…€ë¡œ ë“±ë¡ (ê¶Œì¥)</h2>
                <p class="hint" style="margin-bottom: 12px;">
                    ì—‘ì…€ì—ì„œ í‘œë¡œ ì‘ì„±í•˜ê³  CSV íŒŒì¼ë¡œ ì €ì¥í•œ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”. ê°€ì¥ ì‰½ê³  ë¹ ë¦…ë‹ˆë‹¤!
                </p>
                <p class="hint" style="margin-bottom: 12px;">
                    ê°™ì€ ì¹´ë“œ/ê°™ì€ í‹°ì–´ì˜ ì¶”ê°€ í˜œíƒ í–‰ì€ ì¹´ë“œ ì •ë³´ ì¹¸ì„ ë¹„ì›Œë„ ìœ—í–‰ ê°’ì´ ìë™ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.
                </p>
                <p class="hint" style="margin-bottom: 12px;">
                    í‹°ì–´ìˆœì„œëŠ” ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ìµœì†Œ/ìµœëŒ€ ì‹¤ì  êµ¬ê°„ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì •ë ¬ë©ë‹ˆë‹¤.
                </p>

                <div class="btn-group">
                    <button class="btn-primary" onclick="downloadTemplate()">ğŸ“¥ ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                    <label for="csvFileInput" class="btn-secondary" style="cursor: pointer; display: inline-block;">
                        ğŸ“¤ CSV íŒŒì¼ ì—…ë¡œë“œ
                    </label>
                    <input
                        type="file"
                        id="csvFileInput"
                        accept=".csv"
                        style="display: none;"
                        onchange="handleCsvUpload(event)"
                    >
                    <button class="btn-success" onclick="importFromCsv()" id="csvImportBtn">â˜ï¸ DB ë“±ë¡</button>
                </div>

                <div id="csvStatus"></div>

                <div style="margin-top: 16px;">
                    <div id="csvPreview" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600;">ì—…ë¡œë“œëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</label>
                        <div style="background: #0A0E1A; border: 1px solid #374151; border-radius: 8px; padding: 12px; max-height: 300px; overflow: auto;">
                            <table id="csvPreviewTable" style="width: 100%; color: #E5E7EB; font-size: 12px; border-collapse: collapse;">
                            </table>
                        </div>
                        <p class="hint" style="margin-top: 8px;">ì´ <span id="csvRowCount">0</span>ê°œ í–‰ (ì¹´ë“œ ë°ì´í„° í™•ì¸ í›„ DB ë“±ë¡ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)</p>
                    </div>
                </div>
            </div>


            <div class="card-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">ë“±ë¡ëœ ì¹´ë“œ ëª©ë¡</h2>
                    <button class="btn-secondary" onclick="loadCards()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="card-list-toolbar">
                    <input
                        type="text"
                        id="cardSearchInput"
                        class="card-search"
                        placeholder="ì¹´ë“œëª… ë˜ëŠ” ì¹´ë“œì‚¬ ê²€ìƒ‰"
                        autocomplete="off"
                    >
                </div>
                <div id="cardList">
                    <p style="color: #9CA3AF;">ë¡œë”© ì¤‘...</p>
                </div>
                <div id="cardPagination" class="card-pagination"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://vwfwbskvgkjblwrbdaou.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3Zndic2t2Z2tqYmx3cmJkYW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODgzMDgsImV4cCI6MjA4NTc2NDMwOH0.9ksg54fHe__onKnCZyVXwkkp2sMRoPtQGj_7L2R3lKQ';

        const VALID_CALC_CATEGORIES = new Set([
            'ì™¸ì‹', 'êµí†µ', 'ì‡¼í•‘', 'í¸ì˜ì ', 'ì˜¨ë¼ì¸ì‡¼í•‘', 'ë§ˆíŠ¸', 'ê¸°íƒ€'
        ]);

        const CATEGORY_KEYWORDS = [
            { target: 'êµí†µ', keys: ['êµí†µ', 'ëŒ€ì¤‘êµí†µ', 'ì§€í•˜ì² ', 'ë²„ìŠ¤', 'íƒì‹œ', 'í•­ê³µ', 'ëŒ€í•œí•­ê³µ', 'ì•„ì‹œì•„ë‚˜', 'ì£¼ìœ ', 'í•˜ì´íŒ¨ìŠ¤'] },
            { target: 'ì˜¨ë¼ì¸ì‡¼í•‘', keys: ['ì˜¨ë¼ì¸', 'ì¸í„°ë„·', 'ì¿ íŒ¡', 'ë„¤ì´ë²„', 'ë°°ë‹¬ì•±', 'ì•±ê²°ì œ'] },
            { target: 'í¸ì˜ì ', keys: ['í¸ì˜ì '] },
            { target: 'ë§ˆíŠ¸', keys: ['ë§ˆíŠ¸', 'grocery', 'ì‹ë£Œí’ˆ'] },
            { target: 'ì™¸ì‹', keys: ['ì™¸ì‹', 'ìŒì‹', 'ì‹ë‹¹', 'ë ˆìŠ¤í† ë‘', 'ì¹´í˜', 'ìŠ¤íƒ€ë²…ìŠ¤', 'ì»¤í”¼', 'ë°°ë‹¬'] },
            { target: 'ì‡¼í•‘', keys: ['ì‡¼í•‘', 'ë°±í™”ì ', 'ì•„ìš¸ë ›', 'ë©´ì„¸ì ', 'íŒ¨ì…˜'] },
        ];
        const CSV_CARRY_FORWARD_FIELDS = [
            'ì¹´ë“œëª…', 'ì¹´ë“œì‚¬', 'ì—°íšŒë¹„', 'ì´ë¯¸ì§€ìƒ‰ìƒ', 'ì›”ìµœëŒ€í˜œíƒ', 'ì„¤ëª…',
            'í‹°ì–´ëª…', 'ìµœì†Œì‹¤ì ', 'ìµœëŒ€ì‹¤ì '
        ];

        let supabaseClient = null;
        let currentUser = null;
        let allCards = [];
        let filteredCards = [];
        let currentCardPage = 1;
        const CARD_PAGE_SIZE = 8;
        let cardControlsBound = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Supabase ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ì´ˆê¸°í™” ì¤‘...');
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ');

                // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
                checkExistingSession();
            } else {
                showStatus('loginStatus', 'error', 'Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
        async function checkExistingSession() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    showMainSection();
                }
            } catch (error) {
                console.error('ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œê·¸ì¸ í¼ ì œì¶œ
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');

            if (!email || !password) {
                showStatus('loginStatus', 'error', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© ìƒíƒœ
            loginBtn.disabled = true;
            loginBtnText.innerHTML = '<span class="spinner"></span> ë¡œê·¸ì¸ ì¤‘...';
            showStatus('loginStatus', 'info', 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...');

            try {
                console.log('ë¡œê·¸ì¸ ì‹œë„:', email);

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', error);
                    throw error;
                }

                console.log('ë¡œê·¸ì¸ ì„±ê³µ:', data);
                currentUser = data.user;

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ
                showStatus('loginStatus', 'success', 'âœ… ë¡œê·¸ì¸ ì„±ê³µ!');
                setTimeout(showMainSection, 500);

            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);

                // ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€í™”
                let errorMsg = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ';
                if (error.message.includes('Invalid login credentials')) {
                    errorMsg = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMsg = 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ìë¥¼ ìˆ˜ë™ ì¸ì¦í•˜ê±°ë‚˜, Authentication > Providers > Emailì—ì„œ "Confirm email"ì„ OFFë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('Network')) {
                    errorMsg = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else {
                    errorMsg += error.message;
                }

                showStatus('loginStatus', 'error', errorMsg);
            } finally {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'ë¡œê·¸ì¸';
            }
        }

        // ë©”ì¸ í™”ë©´ í‘œì‹œ
        function showMainSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            bindCardControls();
            loadCards();
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('mainSection').style.display = 'none';
                document.getElementById('password').value = '';
                showStatus('loginStatus', 'info', 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            }
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function bindCardControls() {
            if (cardControlsBound) return;
            const input = document.getElementById('cardSearchInput');
            if (!input) return;
            input.addEventListener('input', () => {
                currentCardPage = 1;
                applyCardFilter();
            });
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    currentCardPage = 1;
                    applyCardFilter();
                }
            });
            cardControlsBound = true;
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function normalizeText(value) {
            return String(value ?? '').trim().toLowerCase();
        }

        function parseSpendAmount(value) {
            const source = String(value ?? '').trim();
            if (!source) return null;

            if (source.includes('ë¬´ì‹¤ì ') || source.includes('ì‹¤ì ì—†ìŒ')) {
                return 0;
            }

            if (source.includes('ë§Œì›')) {
                const match = source.match(/-?\d[\d,]*(?:\.\d+)?/);
                if (match) {
                    const num = Number(match[0].replaceAll(',', ''));
                    if (Number.isFinite(num)) return Math.round(num * 10000);
                }
            }

            const compact = source.replaceAll(',', '').replaceAll('ì›', '').replaceAll(' ', '');
            if (/^-?\d+$/.test(compact)) {
                return parseInt(compact, 10);
            }

            const fallback = source.match(/-?\d[\d,]*/);
            if (fallback) {
                return parseInt(fallback[0].replaceAll(',', ''), 10);
            }
            return null;
        }

        function resolveTierRange(tierName, rawMin, rawMax) {
            const name = String(tierName ?? '').trim();
            let min = parseSpendAmount(rawMin);
            let max = parseSpendAmount(rawMax);

            if ((name.includes('ë¬´ì‹¤ì ') || name.includes('ì‹¤ì ì—†ìŒ')) && min == null) {
                min = 0;
            }

            const rangeMatch = name.match(/(\d[\d,]*(?:\.\d+)?)\s*ë§Œì›\s*[~\-]\s*(\d[\d,]*(?:\.\d+)?)\s*ë§Œì›/);
            if (rangeMatch) {
                if (min == null) min = Math.round(Number(rangeMatch[1].replaceAll(',', '')) * 10000);
                if (max == null) max = Math.round(Number(rangeMatch[2].replaceAll(',', '')) * 10000);
            }

            const aboveMatch = name.match(/(\d[\d,]*(?:\.\d+)?)\s*ë§Œì›\s*ì´ìƒ/);
            if (aboveMatch && min == null) {
                min = Math.round(Number(aboveMatch[1].replaceAll(',', '')) * 10000);
            }

            const belowMatch = name.match(/(\d[\d,]*(?:\.\d+)?)\s*ë§Œì›\s*ë¯¸ë§Œ/);
            if (belowMatch) {
                const bound = Math.round(Number(belowMatch[1].replaceAll(',', '')) * 10000);
                if (min == null) min = 0;
                if (max == null) max = bound - 1;
            }

            const underMatch = name.match(/(\d[\d,]*(?:\.\d+)?)\s*ë§Œì›\s*ì´í•˜/);
            if (underMatch && max == null) {
                max = Math.round(Number(underMatch[1].replaceAll(',', '')) * 10000);
            }

            return {
                minPrevSpend: min ?? 0,
                maxPrevSpend: max,
            };
        }

        function isBlank(value) {
            return String(value ?? '').trim() === '';
        }

        function normalizeCsvRowsWithCarryForward(rows) {
            const carry = {};
            return rows.map((raw) => {
                const row = { ...raw };
                for (const key of CSV_CARRY_FORWARD_FIELDS) {
                    const nextValue = row[key];
                    if (isBlank(nextValue)) {
                        if (!isBlank(carry[key])) {
                            row[key] = carry[key];
                        }
                    } else {
                        carry[key] = nextValue;
                    }
                }
                return row;
            });
        }

        function resolveCalcCategory(rawCategory, manualCategory = '') {
            const manual = String(manualCategory ?? '').trim();
            if (VALID_CALC_CATEGORIES.has(manual)) {
                return manual;
            }

            const source = normalizeText(rawCategory);
            if (!source) return 'ê¸°íƒ€';

            if (source === 'ì™¸ì‹') return 'ì™¸ì‹';
            if (source === 'êµí†µ') return 'êµí†µ';
            if (source === 'ì‡¼í•‘') return 'ì‡¼í•‘';
            if (source === 'í¸ì˜ì ') return 'í¸ì˜ì ';
            if (source === 'ì˜¨ë¼ì¸ì‡¼í•‘') return 'ì˜¨ë¼ì¸ì‡¼í•‘';
            if (source === 'ë§ˆíŠ¸') return 'ë§ˆíŠ¸';
            if (source === 'ê¸°íƒ€') return 'ê¸°íƒ€';

            for (const group of CATEGORY_KEYWORDS) {
                for (const key of group.keys) {
                    if (source.includes(key.toLowerCase())) {
                        return group.target;
                    }
                }
            }

            return 'ê¸°íƒ€';
        }

        function applyCardFilter() {
            const query = (document.getElementById('cardSearchInput')?.value ?? '').trim().toLowerCase();
            if (!query) {
                filteredCards = [...allCards];
            } else {
                filteredCards = allCards.filter((card) => {
                    const name = (card.card_name ?? '').toLowerCase();
                    const issuer = (card.issuer ?? '').toLowerCase();
                    return name.includes(query) || issuer.includes(query);
                });
            }
            renderCardListPage();
        }

        function changeCardPage(nextPage) {
            const totalPages = Math.max(1, Math.ceil(filteredCards.length / CARD_PAGE_SIZE));
            if (nextPage < 1 || nextPage > totalPages) return;
            currentCardPage = nextPage;
            renderCardListPage();
        }

        function renderCardListPage() {
            const listEl = document.getElementById('cardList');
            const paginationEl = document.getElementById('cardPagination');
            const totalCount = filteredCards.length;

            if (totalCount === 0) {
                listEl.innerHTML = '<p style="color: #9CA3AF; text-align: center; padding: 20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                paginationEl.innerHTML = '<span>0ê°œ</span>';
                return;
            }

            const totalPages = Math.max(1, Math.ceil(totalCount / CARD_PAGE_SIZE));
            if (currentCardPage > totalPages) currentCardPage = totalPages;
            const start = (currentCardPage - 1) * CARD_PAGE_SIZE;
            const end = Math.min(start + CARD_PAGE_SIZE, totalCount);
            const pageCards = filteredCards.slice(start, end);

            listEl.innerHTML = pageCards.map(card => `
                <div class="card-item">
                    <div class="card-info">
                        <h3>${escapeHtml(card.card_name)}</h3>
                        <p>${escapeHtml(card.issuer)} Â· ì—°íšŒë¹„ ${(card.annual_fee ?? 0).toLocaleString()}ì›</p>
                    </div>
                    <button class="btn-delete" onclick="deleteCard('${card.id}')">ì‚­ì œ</button>
                </div>
            `).join('');

            paginationEl.innerHTML = `
                <span>${start + 1}-${end} / ${totalCount}ê°œ</span>
                <div class="page-actions">
                    <button class="btn-secondary page-btn" ${currentCardPage <= 1 ? 'disabled' : ''} onclick="changeCardPage(${currentCardPage - 1})">ì´ì „</button>
                    <span>${currentCardPage} / ${totalPages}</span>
                    <button class="btn-secondary page-btn" ${currentCardPage >= totalPages ? 'disabled' : ''} onclick="changeCardPage(${currentCardPage + 1})">ë‹¤ìŒ</button>
                </div>
            `;
        }

        // ì¹´ë“œ ëª©ë¡ ë¡œë“œ
        async function loadCards() {
            try {
                const { data, error } = await supabaseClient
                    .from('card_master')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allCards = data ?? [];
                currentCardPage = 1;
                applyCardFilter();
            } catch (error) {
                console.error('ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('cardList').innerHTML =
                    `<p style="color: #EF4444;">ì˜¤ë¥˜: ${error.message}</p>`;
                document.getElementById('cardPagination').innerHTML = '';
            }
        }

        // ì¹´ë“œ ì‚­ì œ
        async function deleteCard(cardId) {
            const card = allCards.find((item) => item.id === cardId);
            const cardName = card?.card_name ?? 'ì¹´ë“œ';
            if (!confirm(`"${cardName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì¹´ë“œì˜ í˜œíƒ ê·œì¹™ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('card_master')
                    .delete()
                    .eq('id', cardId);

                if (error) throw error;

                alert('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCards();
            } catch (error) {
                alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ========================================
        // CSV ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜
        // ========================================
        let csvData = null;

        // CSV í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadTemplate() {
            const template = `ì¹´ë“œëª…,ì¹´ë“œì‚¬,ì—°íšŒë¹„,ì´ë¯¸ì§€ìƒ‰ìƒ,ì›”ìµœëŒ€í˜œíƒ,ì„¤ëª…,í‹°ì–´ëª…,ìµœì†Œì‹¤ì ,ìµœëŒ€ì‹¤ì ,ì¹´í…Œê³ ë¦¬,ê³„ì‚°ì¹´í…Œê³ ë¦¬,í˜œíƒì„¤ëª…,í˜œíƒíƒ€ì…,í˜œíƒë¥ ,ìµœëŒ€í˜œíƒê¸ˆì•¡,ìš°ì„ ìˆœìœ„
í† ìŠ¤êµí†µí”ŒëŸ¬ìŠ¤,í† ìŠ¤ì¹´ë“œ,0,#2563EB,30000,êµí†µí• ì¸ ì¹´ë“œ,ì „ì›” 30ë§Œì› ì´ìƒ,300000,699999,êµí†µ,êµí†µ,ëŒ€ì¤‘êµí†µ 10% í• ì¸,discount,10,12000,1
,,,,,,,,,í¸ì˜ì ,í¸ì˜ì ,í¸ì˜ì  5% í• ì¸,discount,5,5000,2
,,,,,,ì „ì›” 70ë§Œì› ì´ìƒ,700000,,êµí†µ,êµí†µ,ëŒ€ì¤‘êµí†µ 15% í• ì¸,discount,15,20000,1
ë¬´ì‹¤ì  ë² ì´ì§,ì˜ˆì‹œì¹´ë“œ,0,#10B981,15000,ë¬´ì‹¤ì  ì¹´ë“œ ì˜ˆì‹œ,ì „ì›”ì‹¤ì ì—†ìŒ,0,,ì˜¨ë¼ì¸ì‡¼í•‘,ì˜¨ë¼ì¸ì‡¼í•‘,ì˜¨ë¼ì¸ 1% ì ë¦½,point,1,0,1
ë¬´ì‹¤ì  ë² ì´ì§,ì˜ˆì‹œì¹´ë“œ,0,#10B981,15000,ë¬´ì‹¤ì  ì¹´ë“œ ì˜ˆì‹œ,100ë§Œì› ì´ìƒ,1000000,,êµí†µ,êµí†µ,êµí†µ 2% ì ë¦½,point,2,30000,1`;

            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ì¹´ë“œë“±ë¡_í…œí”Œë¦¿.csv';
            link.click();

            showStatus('csvStatus', 'success', 'âœ… í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ. í‹°ì–´ìˆœì„œëŠ” ìë™ ê³„ì‚°ë˜ë©°, ê°™ì€ ì¹´ë“œ/í‹°ì–´ëŠ” ë¹ˆì¹¸ ìƒì†ì´ ë©ë‹ˆë‹¤.');
        }

        // CSV íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    csvData = parseCsv(text);

                    showCsvPreview(csvData);
                    showStatus('csvStatus', 'success', `âœ… CSV íŒŒì¼ì„ ì½ì—ˆìŠµë‹ˆë‹¤. ${csvData.length}ê°œ í–‰ í™•ì¸`);
                } catch (error) {
                    showStatus('csvStatus', 'error', 'âŒ CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // CSV íŒŒì‹±
        function parseCsv(text) {
            if (!window.Papa) {
                throw new Error('CSV íŒŒì„œ(PapaParse) ë¡œë”© ì‹¤íŒ¨');
            }
            const result = window.Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
                transformHeader: (header) => String(header ?? '').trim(),
            });
            if (result.errors && result.errors.length > 0) {
                throw new Error(`CSV íŒŒì‹± ì˜¤ë¥˜: ${result.errors[0].message}`);
            }
            return result.data ?? [];
        }

        // CSV ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function showCsvPreview(data) {
            if (data.length === 0) return;

            const previewDiv = document.getElementById('csvPreview');
            const table = document.getElementById('csvPreviewTable');
            const rowCount = document.getElementById('csvRowCount');

            // í—¤ë”
            const headers = Object.keys(data[0]);
            let tableHtml = '<thead><tr>';
            headers.forEach(h => {
                tableHtml += `<th style="padding: 8px; border: 1px solid #374151; background: #1A1F2E;">${h}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            // ë°ì´í„° (ìµœëŒ€ 10ê°œë§Œ ë¯¸ë¦¬ë³´ê¸°)
            const previewCount = Math.min(data.length, 10);
            for (let i = 0; i < previewCount; i++) {
                tableHtml += '<tr>';
                headers.forEach(h => {
                    tableHtml += `<td style="padding: 8px; border: 1px solid #374151;">${data[i][h]}</td>`;
                });
                tableHtml += '</tr>';
            }
            tableHtml += '</tbody>';

            table.innerHTML = tableHtml;
            rowCount.textContent = data.length;
            previewDiv.style.display = 'block';
        }

        // CSVì—ì„œ JSONìœ¼ë¡œ ë³€í™˜
        function csvToJson(csvRows) {
            const normalizedRows = normalizeCsvRowsWithCarryForward(csvRows);
            const cardMap = new Map();
            const stats = {
                totalRows: normalizedRows.length,
                totalRules: 0,
                manualMapped: 0,
                autoMapped: 0,
                fallbackEtc: 0,
            };

            normalizedRows.forEach((row, index) => {
                const rowNo = index + 2; // header + 1
                const cardName = String(row['ì¹´ë“œëª…'] ?? '').trim();
                const issuer = String(row['ì¹´ë“œì‚¬'] ?? '').trim();
                const tierName = String(row['í‹°ì–´ëª…'] ?? '').trim();
                const tierRange = resolveTierRange(
                    tierName,
                    row['ìµœì†Œì‹¤ì '],
                    row['ìµœëŒ€ì‹¤ì '],
                );
                const minPrevSpend = tierRange.minPrevSpend;
                const maxPrevSpend = tierRange.maxPrevSpend;
                const priority = parseInt(row['ìš°ì„ ìˆœìœ„']) || 1;
                const rawCategory = String(
                    row['ì¹´í…Œê³ ë¦¬'] ?? row['í˜œíƒì¹´í…Œê³ ë¦¬'] ?? ''
                ).trim();
                const ruleHint = String(
                    row['í˜œíƒì„¤ëª…'] ?? row['í˜œíƒëª…'] ?? row['ë©”ëª¨'] ?? ''
                ).trim();

                if (!cardName || !issuer) {
                    throw new Error(`CSV ${rowNo}í–‰: ì¹´ë“œëª…/ì¹´ë“œì‚¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                }
                if (!tierName) {
                    throw new Error(`CSV ${rowNo}í–‰: í‹°ì–´ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                }
                if (!rawCategory && !ruleHint) {
                    throw new Error(`CSV ${rowNo}í–‰: ì¹´í…Œê³ ë¦¬ ë˜ëŠ” í˜œíƒì„¤ëª… ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                }
                if (maxPrevSpend !== null && maxPrevSpend < minPrevSpend) {
                    throw new Error(`CSV ${rowNo}í–‰: ìµœëŒ€ì‹¤ì ì€ ìµœì†Œì‹¤ì ë³´ë‹¤ ì‘ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }

                const cardKey = `${cardName}_${issuer}`;

                if (!cardMap.has(cardKey)) {
                    cardMap.set(cardKey, {
                        card_name: cardName,
                        issuer: issuer,
                        annual_fee: parseInt(row['ì—°íšŒë¹„']) || 0,
                        image_color: row['ì´ë¯¸ì§€ìƒ‰ìƒ'] || '#3B82F6',
                        monthly_benefit_cap: row['ì›”ìµœëŒ€í˜œíƒ'] ? parseInt(row['ì›”ìµœëŒ€í˜œíƒ']) : null,
                        base_benefit_rate: 0,
                        base_benefit_type: 'discount',
                        description: row['ì„¤ëª…'] || '',
                        tiers: [],
                        tierDefs: new Map(),
                        tierRules: new Map(),
                        tierRowNo: new Map(),
                    });
                }

                const card = cardMap.get(cardKey);
                const tierDefKey = `${minPrevSpend}::${maxPrevSpend ?? 'NULL'}`;
                const existingTier = card.tierDefs.get(tierDefKey);
                if (!existingTier) {
                    card.tierDefs.set(tierDefKey, {
                        tier_name: tierName,
                        min_prev_spend: minPrevSpend,
                        max_prev_spend: maxPrevSpend,
                    });
                    card.tierRules.set(tierDefKey, []);
                    card.tierRowNo.set(tierDefKey, rowNo);
                } else if (!existingTier.tier_name && tierName) {
                    existingTier.tier_name = tierName;
                }

                const manualCalcCategory = row['ê³„ì‚°ì¹´í…Œê³ ë¦¬'] || '';
                const calcSource = rawCategory || ruleHint;
                const calcCategory = resolveCalcCategory(calcSource, manualCalcCategory);
                if (manualCalcCategory && VALID_CALC_CATEGORIES.has(String(manualCalcCategory).trim())) {
                    stats.manualMapped += 1;
                } else if (calcCategory === 'ê¸°íƒ€') {
                    stats.fallbackEtc += 1;
                } else {
                    stats.autoMapped += 1;
                }
                stats.totalRules += 1;

                const tierRuleKey = `${tierDefKey}::${calcCategory}::${priority}`;
                const tierRules = card.tierRules.get(tierDefKey);
                const duplicatedRule = tierRules.find(
                    (r) => `${tierDefKey}::${r.category}::${r.priority}` === tierRuleKey
                );
                if (duplicatedRule) {
                    throw new Error(
                        `CSV ${rowNo}í–‰: "${cardName}" ì¹´ë“œì˜ í‹°ì–´ "${tierName}"ì—ì„œ ì¹´í…Œê³ ë¦¬ "${calcCategory}" + ìš°ì„ ìˆœìœ„ ${priority}ê°€ ì¤‘ë³µë©ë‹ˆë‹¤.`
                    );
                }
                tierRules.push({
                    category: calcCategory,
                    benefit_type: row['í˜œíƒíƒ€ì…'] || 'discount',
                    benefit_rate: parseFloat(row['í˜œíƒë¥ ']) || 0,
                    max_benefit_amount: parseInt(row['ìµœëŒ€í˜œíƒê¸ˆì•¡']) || 0,
                    priority: priority
                });
            });

            for (const cardData of cardMap.values()) {
                const tierEntries = Array.from(cardData.tierDefs.entries()).map(([tierDefKey, tier]) => ({
                    tierDefKey,
                    ...tier,
                    rules: cardData.tierRules.get(tierDefKey) ?? [],
                    rowNo: cardData.tierRowNo.get(tierDefKey) ?? 0,
                }));

                tierEntries.sort((a, b) => {
                    if (a.min_prev_spend !== b.min_prev_spend) {
                        return a.min_prev_spend - b.min_prev_spend;
                    }
                    const aMax = a.max_prev_spend ?? Number.MAX_SAFE_INTEGER;
                    const bMax = b.max_prev_spend ?? Number.MAX_SAFE_INTEGER;
                    if (aMax !== bMax) {
                        return aMax - bMax;
                    }
                    return a.tier_name.localeCompare(b.tier_name);
                });

                // ì‹¤ì  êµ¬ê°„ ë³´ì •/ê²€ì¦
                // maxê°€ ë¹„ì–´ ìˆê³  ë‹¤ìŒ êµ¬ê°„ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ (ë‹¤ìŒ min - 1)ë¡œ ì±„ì›€
                for (let i = 0; i < tierEntries.length - 1; i++) {
                    const current = tierEntries[i];
                    const next = tierEntries[i + 1];

                    if (next.min_prev_spend <= current.min_prev_spend) {
                        throw new Error(
                            `CSV ${next.rowNo}í–‰: "${cardData.card_name}" ì¹´ë“œì˜ ìµœì†Œì‹¤ì ì´ ì˜¤ë¦„ì°¨ìˆœì´ì–´ì•¼ í•©ë‹ˆë‹¤. (${current.tier_name} / ${next.tier_name})`
                        );
                    }

                    if (current.max_prev_spend == null) {
                        current.max_prev_spend = next.min_prev_spend - 1;
                    }

                    if (current.max_prev_spend < current.min_prev_spend) {
                        throw new Error(
                            `CSV ${current.rowNo}í–‰: "${cardData.card_name}" ì¹´ë“œì˜ ì‹¤ì  êµ¬ê°„ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (${current.tier_name})`
                        );
                    }

                    if (current.max_prev_spend === next.min_prev_spend) {
                        current.max_prev_spend = next.min_prev_spend - 1;
                    }

                    if (current.max_prev_spend > next.min_prev_spend) {
                        current.max_prev_spend = next.min_prev_spend - 1;
                        if (current.max_prev_spend < current.min_prev_spend) {
                            throw new Error(
                                `CSV ${next.rowNo}í–‰: "${cardData.card_name}" ì¹´ë“œì˜ ì‹¤ì  êµ¬ê°„ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (${current.tier_name} / ${next.tier_name})`
                            );
                        }
                    }
                }

                for (const entry of tierEntries) {
                    if (entry.max_prev_spend != null && entry.max_prev_spend < entry.min_prev_spend) {
                        throw new Error(
                            `CSV ${entry.rowNo}í–‰: "${cardData.card_name}" ì¹´ë“œì˜ ì‹¤ì  êµ¬ê°„ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (${entry.tier_name})`
                        );
                    }
                }

                cardData.tiers = tierEntries.map((entry, idx) => ({
                    tier_name: entry.tier_name,
                    min_prev_spend: entry.min_prev_spend,
                    max_prev_spend: entry.max_prev_spend,
                    tier_order: idx + 1,
                    rules: entry.rules,
                }));

                delete cardData.tierDefs;
                delete cardData.tierRules;
                delete cardData.tierRowNo;
            }

            return {
                cards: Array.from(cardMap.values()),
                stats,
            };
        }

        // CSV ë°ì´í„°ë¥¼ DBì— ë“±ë¡
        async function importFromCsv() {
            if (!csvData || csvData.length === 0) {
                showStatus('csvStatus', 'error', 'ë¨¼ì € CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const importBtn = document.getElementById('csvImportBtn');
            importBtn.disabled = true;
            showStatus('csvStatus', 'info', 'â³ CSV ë°ì´í„°ë¥¼ ë³€í™˜í•˜ê³  DBì— ë“±ë¡ ì¤‘...');

            try {
                const { cards, stats } = csvToJson(csvData);
                console.log('ë³€í™˜ëœ ì¹´ë“œ ë°ì´í„°:', cards);

                let successCount = 0;

                for (const cardData of cards) {
                    // ì¹´ë“œ ë§ˆìŠ¤í„° ë“±ë¡
                    const { data: cardMaster, error: cardError } = await supabaseClient
                        .from('card_master')
                        .upsert({
                            card_name: cardData.card_name,
                            issuer: cardData.issuer,
                            annual_fee: cardData.annual_fee,
                            image_color: cardData.image_color,
                            monthly_benefit_cap: cardData.monthly_benefit_cap,
                            base_benefit_rate: cardData.base_benefit_rate,
                            base_benefit_type: cardData.base_benefit_type,
                            description: cardData.description,
                        }, {
                            onConflict: 'card_name,issuer'
                        })
                        .select()
                        .single();

                    if (cardError) throw cardError;

                    // ê¸°ì¡´ tiers ì‚­ì œ
                    await supabaseClient
                        .from('card_benefit_tiers')
                        .delete()
                        .eq('card_id', cardMaster.id);

                    // ìƒˆ tiers ë“±ë¡
                    for (const tier of cardData.tiers) {
                        const { data: tierData, error: tierError } = await supabaseClient
                            .from('card_benefit_tiers')
                            .insert({
                                card_id: cardMaster.id,
                                tier_name: tier.tier_name,
                                min_prev_spend: tier.min_prev_spend,
                                max_prev_spend: tier.max_prev_spend,
                                tier_order: tier.tier_order,
                            })
                            .select()
                            .single();

                        if (tierError) throw tierError;

                        // rules ë“±ë¡
                        for (const rule of tier.rules) {
                            const { error: ruleError } = await supabaseClient
                                .from('card_tier_rules')
                                .insert({
                                    tier_id: tierData.id,
                                    category: rule.category,
                                    benefit_type: rule.benefit_type,
                                    benefit_rate: rule.benefit_rate,
                                    max_benefit_amount: rule.max_benefit_amount,
                                    priority: rule.priority,
                                });

                            if (ruleError) throw ruleError;
                        }
                    }

                    successCount++;
                    showStatus('csvStatus', 'info', `â³ ì§„í–‰ ì¤‘... ${successCount}/${cards.length}ê°œ ì¹´ë“œ`);
                }

                showStatus(
                    'csvStatus',
                    'success',
                    `âœ… ì™„ë£Œ! ${successCount}ê°œ ì¹´ë“œ ë“±ë¡ | CSV ${stats.totalRows}í–‰ â†’ ë£° ${stats.totalRules}ê°œ (ìˆ˜ë™ ${stats.manualMapped}, ìë™ ${stats.autoMapped}, ê¸°íƒ€ ${stats.fallbackEtc})`
                );
                loadCards();

                // ì´ˆê¸°í™”
                csvData = null;
                document.getElementById('csvFileInput').value = '';
                document.getElementById('csvPreview').style.display = 'none';

            } catch (error) {
                console.error('CSV ë“±ë¡ ì˜¤ë¥˜:', error);
                showStatus('csvStatus', 'error', 'âŒ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            } finally {
                importBtn.disabled = false;
            }
        }

        // ========================================
        // JSON ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜
        // ========================================

        // ì˜ˆì‹œ JSON ë¡œë“œ
        function loadSample() {
            document.getElementById('jsonInput').value = `[
  {
    "card_name": "í† ìŠ¤ êµí†µ í”ŒëŸ¬ìŠ¤",
    "issuer": "í† ìŠ¤ì¹´ë“œ",
    "annual_fee": 0,
    "image_color": "#2563EB",
    "monthly_benefit_cap": 30000,
    "base_benefit_rate": 0,
    "base_benefit_type": "discount",
    "description": "ì¹´ë“œ ë¼ìš´ì§€ ì°¸ê³  ë“±ë¡ ì˜ˆì‹œ",
    "tiers": [
      {
        "tier_name": "30ë§Œì› ì´ìƒ",
        "min_prev_spend": 300000,
        "max_prev_spend": 699999,
        "tier_order": 1,
        "rules": [
          {
            "category": "êµí†µ",
            "benefit_type": "discount",
            "benefit_rate": 10,
            "max_benefit_amount": 12000,
            "priority": 1
          },
          {
            "category": "í¸ì˜ì ",
            "benefit_type": "discount",
            "benefit_rate": 5,
            "max_benefit_amount": 5000,
            "priority": 2
          }
        ]
      },
      {
        "tier_name": "70ë§Œì› ì´ìƒ",
        "min_prev_spend": 700000,
        "max_prev_spend": null,
        "tier_order": 2,
        "rules": [
          {
            "category": "êµí†µ",
            "benefit_type": "discount",
            "benefit_rate": 15,
            "max_benefit_amount": 20000,
            "priority": 1
          }
        ]
      }
    ]
  }
]`;
            showStatus('importStatus', 'info', 'âœ… ì˜ˆì‹œ JSONì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }

        // JSON ê²€ì¦
        function validateJson() {
            const input = document.getElementById('jsonInput').value.trim();
            if (!input) {
                showStatus('importStatus', 'error', 'JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const cards = JSON.parse(input);
                if (!Array.isArray(cards)) {
                    throw new Error('ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                }

                for (let i = 0; i < cards.length; i++) {
                    const card = cards[i];
                    if (!card.card_name || !card.issuer) {
                        throw new Error(`${i + 1}ë²ˆì§¸ ì¹´ë“œ: card_name, issuerëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                    }
                    if (!Array.isArray(card.tiers) || card.tiers.length === 0) {
                        throw new Error(`${card.card_name}: tiersë¥¼ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    }
                }

                showStatus('importStatus', 'success', `âœ… ê²€ì¦ í†µê³¼: ${cards.length}ê°œ ì¹´ë“œ ë“±ë¡ ê°€ëŠ¥`);
            } catch (error) {
                showStatus('importStatus', 'error', 'âŒ JSON ê²€ì¦ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì¹´ë“œ ëŒ€ëŸ‰ ë“±ë¡
        async function importCards() {
            const input = document.getElementById('jsonInput').value.trim();
            if (!input) {
                showStatus('importStatus', 'error', 'JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let cards;
            try {
                cards = JSON.parse(input);
                if (!Array.isArray(cards)) {
                    throw new Error('ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                }
            } catch (error) {
                showStatus('importStatus', 'error', 'âŒ JSON íŒŒì‹± ì‹¤íŒ¨: ' + error.message);
                return;
            }

            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            showStatus('importStatus', 'info', 'â³ DB ë°˜ì˜ ì¤‘...');

            try {
                let successCount = 0;

                for (const cardData of cards) {
                    // ì¹´ë“œ ë§ˆìŠ¤í„° ë“±ë¡
                    const { data: cardMaster, error: cardError } = await supabaseClient
                        .from('card_master')
                        .upsert({
                            card_name: cardData.card_name,
                            issuer: cardData.issuer,
                            annual_fee: cardData.annual_fee || 0,
                            image_color: cardData.image_color || '#3B82F6',
                            monthly_benefit_cap: cardData.monthly_benefit_cap || null,
                            base_benefit_rate: cardData.base_benefit_rate || 0,
                            base_benefit_type: cardData.base_benefit_type || 'discount',
                            description: cardData.description || '',
                        }, {
                            onConflict: 'card_name,issuer'
                        })
                        .select()
                        .single();

                    if (cardError) throw cardError;

                    // ê¸°ì¡´ tiers ì‚­ì œ
                    await supabaseClient
                        .from('card_benefit_tiers')
                        .delete()
                        .eq('card_id', cardMaster.id);

                    // ìƒˆ tiers ë“±ë¡
                    for (const tier of cardData.tiers) {
                        const { data: tierData, error: tierError } = await supabaseClient
                            .from('card_benefit_tiers')
                            .insert({
                                card_id: cardMaster.id,
                                tier_name: tier.tier_name,
                                min_prev_spend: tier.min_prev_spend,
                                max_prev_spend: tier.max_prev_spend,
                                tier_order: tier.tier_order,
                            })
                            .select()
                            .single();

                        if (tierError) throw tierError;

                        // rules ë“±ë¡
                        for (const rule of tier.rules) {
                            const calcCategory = resolveCalcCategory(
                                rule.category,
                                rule.calc_category || ''
                            );
                            const { error: ruleError } = await supabaseClient
                                .from('card_tier_rules')
                                .insert({
                                    tier_id: tierData.id,
                                    category: calcCategory,
                                    benefit_type: rule.benefit_type,
                                    benefit_rate: rule.benefit_rate,
                                    max_benefit_amount: rule.max_benefit_amount,
                                    priority: rule.priority || 1,
                                });

                            if (ruleError) throw ruleError;
                        }
                    }

                    successCount++;
                    showStatus('importStatus', 'info', `â³ ì§„í–‰ ì¤‘... ${successCount}/${cards.length}`);
                }

                showStatus('importStatus', 'success', `âœ… ì™„ë£Œ: ${successCount}ê°œ ì¹´ë“œê°€ DBì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadCards();
            } catch (error) {
                console.error('ë“±ë¡ ì˜¤ë¥˜:', error);
                showStatus('importStatus', 'error', 'âŒ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            } finally {
                importBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
